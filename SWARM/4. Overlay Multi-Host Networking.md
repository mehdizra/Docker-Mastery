---
tags:
  - network
  - docker
  - swarm
up: "[[3. Swarm Cluster]]"
dow: 
date: 2024-05-12
---
![[8. Swarm Basic Features and How to Use Them In Your Workflow __ 1.2 S08 Swarm Basic Features Slides.pdf]]

## Overlay Network
- ุจุง ุฏุณุชูุฑ `network create --driver overlay` ุงุฌุงุฏ ู ุดูุฏ.
- ุฏุฑุงูุฑ overlay ุญุฌู ุตุฑูุง ุชุฑุงูฺฉ ุฏุงุฎู ุณูุงุฑู ุฑุง ูุฏุฑุช ูฺฉูุฏุ ุจุงุนุซ ู ุดูุฏ ูุง ุฏุงุฆูุงู ุจุง ุชูุธูุงุช ุดุจฺฉู ุฏุฑ ููุฏูุง ุฌุฏุงฺฏุงูู ุฏุฑฺฏุฑ ูุจุงุดู.
- ุงู ุชุฑุงูฺฉ ูุชูุงูุฏ ุงุฒ ุทุฑู ุชููู IPSec ุฑูุฒูฺฏุงุฑ ุดูุฏ ฺฉู ุงู ุขูพุดู ุจู ุตูุฑุช ูพุด ูุฑุถ ุจู ุฎุงุทุฑ ฺฉุงูุด ุณุฑุนุช ุฎุงููุด ุงุณุช.
- ูุฑ ุณุฑูุณ ู ุชูุงูุฏ ุจู (ูฺ ุง ฺฉ ุง ฺูุฏ) ุดุจฺฉู overlay ูุชุตู ุจุงุดุฏ.

### ุชูุงูุช ุดุจฺฉู ูุง ุฏุฑ ุฒูุงู ูุนุงู ู ุบุฑ ูุนุงู ุจูุฏู swarm
```bash
# swarm inactive
[node3] (local) root@192.168.0.26 ~
$ docker network ls
NETWORK ID     NAME      DRIVER    SCOPE
125e1f541ccb   bridge    bridge    local
38c21f7f0841   host      host      local
51849e593da0   none      null      local
```
```bash
# swarm activ
[node1] (local) root@192.168.0.28 ~
$ docker network ls
NETWORK ID     NAME              DRIVER    SCOPE
9d064a125143   bridge            bridge    local
ec708d52abe6   docker_gwbridge   bridge    local
e84711d40c34   host              host      local
0zj04n9k3u6v   ingress           overlay   swarm
80277512a504   none              null      local
```
ุฏู ุดุจฺฉู ุฌุฏุฏ ุจุง ูุนุงู ุดุฏู swarm ุงุถุงูู ู ุดููุฏ ฺฉู `docker_gwbridge` ูุฑุจูุท ุจู ุงุฑุชุจุงุทุงุช swarm ุจุง ุฎุงุฑุฌ ุงุณุช. ู `ingress` ูุฑุจูุท ุจู ุงุฑุชุจุงุทุงุช ุฏุงุฎู swarm ุงุณุช.

ุงฺฏุฑ ูุง ุงู ุฏู ุณุฑูุณ ุฑุง ฺฉู ุดุงูู ฺฉ `postgress database` ู ฺฉ `drupal` ุงุณุช ุฑุง ุฑู ฺฉ ุณูุงุฑู ุจุง 3 ููุฏ ูุนุงู ฺฉูู:
```bash
[node1] (local) root@192.168.0.28 ~
$ docker service create --network mynet --name dbase -e POSTGRESS_PASSWORD=mypass postgres
```
```bash
[node2] (local) root@192.168.0.27 ~
$ docker service create --name website --network mynet -p 80:80 drupal
```
ุจุง ุจุฑุฑุณ IP ูุง ูุฑ ุณู ููุฏ ุฏุฑ ฺฉ browser ูุดุงูุฏู ุฎูุงูู ฺฉุฑุฏ ฺฉู ูุฑ ุณู ููุฏ (ุจุง ipูุง ูุฌุฒุง) ฺฉู ุนุถู ุณูุงุฑู ูุณุชูุฏ ูุจ ุณุงุช ุฑุง ููุงุด ู ุฏููุฏ. ฺุฑุงุ Routing Mesh
## Routing Mesh
- Routes ingress (incoming) packets for a Service to proper Task 
- Spans all nodes in Swarm - Uses IPVS from Linux Kernel 
- Load balances Swarm Services across their Tasks 
- Two ways this works: 
- Container-to-container in a Overlay network (uses VIP) 
- External traffic incoming to published ports (all nodes listen)
- ุฑูุชูฺฏ ูุด ฺฉ ุดุจฺฉู ingress (incoming) ุงุณุช ฺฉู ูพฺฉุช ูุง ฺฉ ุณุฑูุณ ุฑุง ุฑู Task ูุง(containerูุง) ุขู ุณุฑูุณ ุจุฑ ุฑู ูุฑ ููุฏ ุชูุฒุน ูฺฉูุฏ. ฺุฑุง ฺฉู ุฑู ูุฑ ููุฏ ูุชูุงูู ุณุฑูุณ ูุง ู ฺฉุงูุชูุฑูุง ูุฎุชูู ุฏุงุดุชู ุจุงุดู.
- ุจุฑุง ุงูฺฉุงุฑ ุงุฒ ูุงุจูุช ูุง ุงููู ฺฉุฑูู ุงุณุชูุงุฏู ู ฺฉูุฏ.
- ูุฏู ุฑูุชูฺฏ ูุด load balancing ุฑู ุชูุงู ููุฏูุง ู listen ฺฉุฑุฏู ุจุฑุง ุชุฑุงูฺฉ ุฎุงุฑุฌ ุงุฒ ุทุฑู ุชูุงู ููุฏูุงุณุช.
- ุจู ุฏู ุฑูุด ฺฉุงุฑ ูฺฉูุฏ:
	- ุฏุฑ ุฒูุงู ฺฉู ฺฉ ุณุฑูุณ ูุง ุญุฏุงูู ุฏู replicas ุฏุงุฑุฏุ ฺฉ VIP (IP ูุฌุงุฒ) ู ูุฎู ุชูุณุท ุฏุงฺฉุฑ ุฏุฑ ุฌูู ุขููุง ูุฑุงุฑ ูฺฏุฑุฏ ฺฉู ูุธูู ุขู load balancing ุฏุฑูู ุดุจฺฉู swarm ุงุณุช. ุนู ุงฺฏุฑ ุชุนุฏุงุฏ ููุฏูุง ูุง ุจุฑุง ฺฉ ุณุฑูุณ ุฒุงุฏ ุจุงุดุฏุ ูุง ูุงุฒููุฏ ุจุงูุงูุณ ฺฉุฑุฏู ุชุฑุงูฺฉ ุฏุงุฎู ุขููุง ูุณุชู. ุจูุงุจุฑุงู ุจุง ุงุฌุงุฏ ฺฉ ุณุฑูุณ ุฏุฑ ฺฉ ุณูุงุฑู ฺฉ VIP ุจู DNS name ุณุฑูุณ map ู ุดูุฏ ู DNS name ฺฉ ุณุฑูุณ ุจู ุตูุฑุช ูพุด ูุฑุถ ูุงู ุณุฑูุณ ุงุณุช. ูุซูุง ูุฑุถ ุจฺฏุฑู ุณุฑูุณ ุจู ูุงู my-web ุฏุงุฑู. ุชูุงู ฺฉุงูุชูุฑูุง ุฏฺฏุฑ ุฏุฑ ุณุฑูุณ ูุง ุฏฺฏุฑ ุฏุฑ ููู Swarm ุฏุฑ ุตูุฑุช ฺฉู ุจุฎูุงููุฏ ุจุง ุงู ุณูุฑุณ ุตุญุจุช ฺฉููุฏ ููุท ุงุฒ ููุงู DNS name ุณุฑูุณ ุนู my-web ุงุณุชูุงุฏู ูฺฉููุฏ ฺฉู ฺฉ IP ูุฌุงุฒ ุฏุงุฑุฏ ู ุฑูุชูฺฏ ูุด ูพฺฉุช ูุง ุงุฑุณุงู ุฑุง ุฏุฑ ููุฏูุง ุงู ุณุฑูุณ ุชูุฒุน ูฺฉูุฏ![[Pasted image 20240513150902.png]]
	- ุฏุฑ ุฒูุงู ฺฉู ูุง ุฏุฑ ฺฉ Swarm ุณุฑูุณ ูุง ูุฎุชูู ุฑุงู ุงูุฏุงุฒ ูฺฉููุ ุชูุงู ููุฏูุง ุงู ุณุฑูุณ ูุง ุจู ูพูุฑุช ฺฉู publish ุดุฏู ฺฏูุด ู ุฏููุฏ ู ุชุฑุงูฺฉ ุฎุงุฑุฌ ุฑุง ุจู swarm load balancer ุง ููุงู routing mesh ุชุญูู ูุฏููุฏ ู ุฑูุชูฺฏ ูุด ุขู ุฑุง ุจู ฺฉุงูุชูุฑ ูุฑุจูุทู ุชุญูู ู ุฏูุฏ. ุงู ุนู ูุง ูุงุฒููุฏ ุงูุฌุงู ุชูุธูุงุช DNS ู Firewall ุจุฑุง ููุฏูุง ูุณุชู ุง ุฏุฑ ุตูุฑุช ุฎุงุฑุฌ ุดุฏู ฺฉ ููุฏ ุงุฒ swarm ฺฉ ููุฏ ุจุง ุชูุธูุงุช ููุฑุฏ ูุงุฒ ุงุฌุงุฏ ู ุดูุฏ.![[ingress-routing-mesh.jpeg]]

> [!hint] Routing Mesh VS Round Robin
> ุฑูุชูฺฏ ูุด ุจุง ุฑุงูุฏ ุฑุงุจู ูุชูุงูุช ุงุณุช ุงูุง ุงูฺฉุงู ูุนุงู ุณุงุฒ ุฑุงูุฏ ุฑุงุจู ูู ูุฌูุฏ ุฏุงุฑุฏ. ุงูุง ุจู ุฌุง ุฌูฺฏุฏู ุจุง DNS ุจุฑุง ูุนุงู ุณุงุฒ ุฑุงูุฏ ุฑุงุจู ูุชูุงูู ุงุฒ ููุงู VIP ุงุณุชูุงุฏู ฺฉูู ฺฉู ูุดุงุจู ฺฉ ููุฏุจุงูุงูุณุฑ ุณุฎุช ุงูุฒุงุฑ ุนูู ู ฺฉูุฏ.

### Routing Mesh Sample
```bash
[node1] (local) root@192.168.0.8 ~
$ docker node ls
ID                            HOSTNAME   STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION
kf81wvsrhwglcebble73enutp *   node1      Ready     Active         Leader           24.0.7
b88dqtamodkucy4yq2ae52422     node2      Ready     Active         Reachable        24.0.7
sg84jsgsyxmfyfwsc9suhdhfu     node3      Ready     Active         Reachable        24.0.7

[node1] (local) root@192.168.0.8 ~
$ docker service create --replicas 2 -p 9200:9200 elasticsearch:2
qqsgwc3b11l4w62jf5g7ut910
overall progress: 0 out of 3 tasks 
1/3: preparing [=================================>                 ] 
2/3: preparing [=================================>                 ] 

[node1] (local) root@192.168.0.8 ~
$ curl localhost:9200
{
  "name" : "Coldblood",
  "cluster_name" : "elasticsearch",
  "cluster_uuid" : "9hL8KK6mRSKXgCQL9-7Glw",
  "version" : {
    "number" : "2.4.6",
    "build_hash" : "5376dca9f70f3abef96a77f4bb22720ace8240fd",
    "build_timestamp" : "2017-07-18T12:17:44Z",
    "build_snapshot" : false,
    "lucene_version" : "5.5.4"
  },
  "tagline" : "You Know, for Search"
}
[node1] (local) root@192.168.0.8 ~
$ curl localhost:9200
{
  "name" : "Bucky III",
  "cluster_name" : "elasticsearch",
  "cluster_uuid" : "AU_yzZpwRp6rXKAUMZzsMA",
  "version" : {
    "number" : "2.4.6",
    "build_hash" : "5376dca9f70f3abef96a77f4bb22720ace8240fd",
    "build_timestamp" : "2017-07-18T12:17:44Z",
    "build_snapshot" : false,
    "lucene_version" : "5.5.4"
  },
  "tagline" : "You Know, for Search"
}
[node1] (local) root@192.168.0.8 ~
```
ุจุง ูุฑ ุจุงุฑ ุงูุฌุงู curl ุฑู localhost:9200 ุฌูุงุจ ูุง ูุชูุงูุช ุงุฒ ููุฏูุง ูุฎุชูู ูฺฏุฑู
### Routing Mesh Limitation: 
	- This is stateless load balancing 
	- This load balancer is at OSI in Layer 3 (TCP), not Layer 4 (DNS) 
#### Solutions: 
	- Using Nginx or HAProxy as a load balancer proxy
	- Using Docker Enterprise Edition, which comes with built-in Layer4 web proxy
- ุจุง ููุฏุจุงูุงูุณุฑ routing mesh ุงูฺฉุงู ุงุฌุงุฏ ุงุฑุชุจุงุท ุฏุงุฆู ฺฉ ฺฉุงูุชูุฑ ุจุง ฺฉ ฺฉูุงูุช ูุณุช ู ุงุตุทูุงุญุง session ูุง ุฐุฎุฑู ูู ุดููุฏ ฺุฑุง ฺฉู ุงู ฺฉ ููุฏ ุจุงูุงูุณุฑ ุฏุฑ ูุงู ุณูู `IP` ู ุฏุฑ ูุงู ฺูุงุฑู `DNS` ูุฑุงุฑ ูุฏุงุฑุฏ
- ุงฺฏุฑ ุจุฎูุงูู ฺูุฏู ูุจ ุณุงุช ุฑุง ุฑู ฺฉ ูพูุฑุชุ ููฺูู ฺฉ ุณุฑูุฑ ุฑุงู ุงูุฏุงุฒ ฺฉูู ููุชูุงูู ุงุฒู ููุฏ ุจุงูุงูุณุฑ ุงุณุชูุงุฏู ฺฉูู
- ุจุฑุง ูุฑ ุฏู ูุดฺฉู ุจุงูุง ุฑุงู ุญู ููุฌูุฏ ุงุณุชูุงุฏู ุงุฒ ฺฉ ูุจ ูพุฑุงฺฉุณ ุจู ุนููุงู ูุงู ููุฏ ุจุงูุงูุณุฑ ุงุณุช ฺฉู ุงุฑุชุจุงุทุงุช ฺฉูุงูุช ู ุณุฑูุฑ ุฏุฑ cache ุฎูุฏ ูฺฏุงู ูุฏุงุฑุฏ.
	- ุจุฑุง ุงู ุงูุฑ ูู ูุชูุงูู ุงุฒ Nginx ุง HAProxy ุงุณุชูุงุฏู ูฺฉูู ู ูู ูุชูุงูู ุงุฒ ูุณุฎู ูพูู Docker Enterprise ุงุณุชูุงุฏู ฺฉูู ฺฉู ฺฉ ูุจ ูพุฑุงฺฉุณ ุฏุงุฎู ุฏุฑูู ุฎูุฏุด ุฏุงุฑุฏ ู ุงู ูุดฺฉู ุฑุง ุญู ูฺฉูุฏ.

## docker swarm app assignment
ุจุฑุง ุงู ุงูุชุญุงู ูุงู ุฒุฑ ุฑุง ุจุฎูุงูุฏ:
### Assignment File
![[2Projects๐ฝ/Docker Mastery/SWARM/files/README]]
### Assignment Answer
```bash
mmzare@:)Linux~$: docker network create --driver overlay frontend
887xz5q7jvvcufizbps6x1vpr
mmzare@:)Linux~$: docker network create --driver overlay backend
nz6drcn00v66g6ufeltyyw5m6

mmzare@:)Linux~$: docker service create --replicas 2 --name vote --network frontend -p 80:80 bretfisher/examplevotingapp_vote
k5t69fw8f9p76cyijlc76p620
overall progress: 2 out of 2 tasks
1/2: running   [==================================================>]
2/2: running   [==================================================>]
verify: Service converged

mmzare@:)Linux~$: docker service create --name redis --network frontend redis:3.2
x34ap031zf9xahos5mb2m85gv
overall progress: 1 out of 1 tasks
1/1: running   [==================================================>]
verify: Service converged

mmzare@:)Linux~$: docker service create --name worker --network frontend --network backend bretfisher/examplevotingapp_worker
d2t2pcxwjulgmf5t9yhy00ue7
overall progress: 1 out of 1 tasks
1/1: running   [==================================================>]
verify: Service converged

mmzare@:)Linux~$: docker service create --name db --network backend -e POSTGRES_HOST_AUTH_METHOD=trust --mount type=volume,source=db-data,target=/var/lib/postgresql/data postgres:9.6.1
a7vhejams8m753xyuo4vwzqzw
overall progress: 1 out of 1 tasks
1/1: running   [==================================================>]
verify: Service converged

mmzare@:)Linux~$: docker service create --name result -p 5001:80 --network backend bretfisher/examplevotingapp_result
xcaeo90qg2h8b9mn5zq2ewtfw
overall progress: 1 out of 1 tasks
1/1: running   [==================================================>]
verify: Service converged

mmzare@:)Linux~$: docker service ls
ID             NAME      MODE         REPLICAS   IMAGE                                       PORTS
a7vhejams8m7   db        replicated   1/1        postgres:9.6.1
x34ap031zf9x   redis     replicated   1/1        redis:3.2
xcaeo90qg2h8   result    replicated   1/1        bretfisher/examplevotingapp_result:latest   *:5001->80/tcp
k5t69fw8f9p7   vote      replicated   2/2        bretfisher/examplevotingapp_vote:latest     *:80->80/tcp
d2t2pcxwjulg   worker    replicated   1/1        bretfisher/examplevotingapp_worker:latest
```
ุจุง ุณู ุจุฑูุฒุฑ ูุฎุชูู ุฏุฑ ุขุฏุฑุณ localhost ุฏุฑ ุฑุง ฺฏุฑ ุดุฑฺฉุช ฺฉุฑุฏู ู ูุชุฌู ุฑุง ุฏุฑ localhost:5001 ูุดุงูุฏู ฺฉุฑุฏู:
![[Pasted image 20240515130949.png]]
> [!idea] ุจุง ุงูุชุฎุงุจ ูุฑ ฺฉุฏุงู ุงุฒ ฺฏุฒูู ูุง ูุชุงุฌ ุฏุฑ ุจุฎุด `result` ุจู ุตูุฑุช ููุฒูุงู ุชุบุฑ ูฺฉุฑุฏ. !
> ุนูุช ุขู ุงุณุชูุงุฏู ุงุฒ websocket API ุงุณุช.

